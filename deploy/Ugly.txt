<!DOCTYPE html>
<html>
<head>
    <title>Custom Grid with Deep Export</title>
    <!--  (c) 2015 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Tue Jul 11 2017 13:22:25 GMT-0700 (PDT) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue Jul 11 2017 13:22:25 GMT-0700 (PDT)";
        var CHECKSUM = 19797156960;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred");console.log("_checkChecksum",a);var c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){return text=a.responseText,CHECKSUM&&CHECKSUM!==c._generateChecksum(text)?(console.log("Checksums don't match!"),void b.resolve(!1)):void b.resolve(!0)}}),b.promise},afterRender:function(){var a=Rally.getApp();a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml}),this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"Build date/time: "+APP_BUILD_DATE})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.HierarchyExporter",{logger:new Rally.technicalservices.Logger,mixins:{observable:"Ext.util.Observable"},records:void 0,constructor:function(a){this.mixins.observable.constructor.call(this,a),this.records=[],this.fileName=a.fileName||"export.csv",this.columns=a.columns||[{dataIndex:"FormattedID",text:"ID"},{dataIndex:"Name",text:"Name"}],this.portfolioItemTypeObjects=a.portfolioItemTypeObjects||[]},setRecords:function(a,b){this.records=(this.records||[]).concat(b)},"export":function(){this.fireEvent("exportupdate","Preparing export data"),this.logger.log("export",this.records,this);var a=_.filter(this.columns,function(a){return"FormattedID"!==a.dataIndex}),b=this._buildHierarchy(),c=this._getExportableHierarchicalData(b,a);a=this._getAncestorTypeColumns(b[0]._type).concat(a),this.logger.log("columns",a);var d=this._transformDataToDelimitedString(c,a);this.saveCSVToFile(d,this.fileName),this.fireEvent("exportcomplete")},_buildHierarchy:function(){var a=[];this.logger.log("_buildHierarchy",this.records.length);var b=_.reduce(this.records,function(a,b){var c=b.get("ObjectID");return a[c]=b.getData(),a[c].loadedChildren=[],a},{});this.logger.log("_buildhierarchy Hash",b),this.records=null;for(var c in b){var d=b[c],e=d.Parent&&d.Parent.ObjectID||d.PortfolioItem&&d.PortfolioItem.ObjectID||d.WorkProduct&&d.WorkProduct.ObjectID;if(e&&b[e])b[e].loadedChildren.push(d);else{var f=d.Parent&&d.Parent.Parent&&d.Parent.Parent.ObjectID||null;f&&b[f]?b[f].loadedChildren.push(d):a.push(d)}}return a},_transformDataToDelimitedString:function(a,b){var c=[],d=",",e="\r\n",f=new RegExp(d+'|"|\r|\n',"g"),g=new RegExp("</?[^>]+>","g"),h=new RegExp("&nbsp;","ig"),i=_.map(b,function(a){return a.dataIndex}),j=_.pluck(b,"text");return c.push(j.join(d)),Ext.Array.each(a,function(a){var b=[];Ext.Array.each(i,function(c){var d=a[c];console.log("column-key",c,a),"Parent"===c&&(d=a[c]||a.PortfolioItem),d&&(g.test(d)&&(d=d.replace("<br>","\r\n"),this.logger.log("html val",d),d=Ext.util.Format.htmlDecode(d),d=Ext.util.Format.stripTags(d),this.logger.log("stripped html val",d)),h.test(d)&&(d=d.replace(h," ")),f.test(d)&&(d=d.replace(/\"/g,'""'),d=Ext.String.format('"{0}"',d))),b.push(d)},this),c.push(b.join(d))},this),c.join(e)},_getExportableHierarchicalData:function(a,b){var c=[];return _.each(a,function(a){var d={},e=this._getExportDataRow(a,b,d);c.push(e),this._addExportChildren(a,c,b,d)},this),c},_addExportChildren:function(a,b,c,d){var e=Ext.clone(d),f=this;e[a._type]=a.FormattedID;var g=a.loadedChildren;g&&g.length>0&&_.each(g,function(a){var d=this._getExportDataRow(a,c,e);b.push(d),f._addExportChildren(a,b,c,e)},this)},getTypePathDisplayName:function(a){if("hierarchicalrequirement"===a.toLowerCase())return"User Story";if("task"===a.toLowerCase())return"Task";var b="";return Ext.Array.each(this.portfolioItemTypeObjects,function(c){return c.typePath.toLowerCase()===a.toLowerCase()?(b=c.name,!1):void 0}),b},_getExportDataRow:function(a,b,c){var d=Ext.clone(c),e=a._type;return d[e]=a.FormattedID,d.type=this.getTypePathDisplayName(a._type),_.each(b,function(b){var c=b.dataIndex||null;if(c){var e=a[c];if("Parent"===c&&(e=a[c]||a.PortfolioItem),Ext.isObject(e))if(e._tagsNameArray&&e._tagsNameArray.length>0){var f=_.pluck(e._tagsNameArray,"Name");d[c]=f.join(",")}else e.FormattedID?d[c]=e.FormattedID+": "+e._refObjectName:d[c]=e._refObjectName;else Ext.isDate(e)?d[c]=Rally.util.DateTime.formatWithDefaultDateTime(e):d[c]=e}}),d},_getAncestorTypeColumns:function(a){var b=this.portfolioItemTypeObjects,c=-1;Ext.Array.each(b,function(b,d){b.typePath.toLowerCase()===a.toLowerCase()&&(c=d)});var d=[{dataIndex:"task",text:"Task"},{dataIndex:"hierarchicalrequirement",text:"User Story"}];return c>=0&&(d=d.concat(Ext.Array.map(b.slice(0,c+1),function(a){return{dataIndex:a.typePath.toLowerCase(),text:a.name}})),d.push({dataIndex:"type",text:"Artifact Type"})),d.reverse(),d},saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}}),Ext.define("Rally.technicalservices.HierarchyLoader",{logger:new Rally.technicalservices.Logger,storyModelName:"hierarchicalrequirement",taskModelName:"task",mixins:{observable:"Ext.util.Observable"},model:void 0,filters:void 0,fetch:void 0,childModels:void 0,maxParallelCalls:6,constructor:function(a){this.mixins.observable.constructor.call(this,a),this.portfolioItemTypes=a.portfolioItemTypes||[],this.model=a.model||null,this.fetch=a.fetch||[],this.filters=a.filters||[],this.loadChildModels=a.loadChildModels||[]},load:function(){if(!this.model)return void this.fireEvent("hierarchyloaderror","No model specified.");if(0===this.portfolioItemTypes.length)return void this.fireEvent("hierarchyloaderror","Portfolio Item Types not initialized.");if(!(this.loadChildModels instanceof Array))return void this.fireEvent("hierarchyloaderror","No child models specified.");for(var a=[],b=0;b<this.loadChildModels.length+2;b++)a.push(this.fetchNextLevel);Deft.Chain.pipeline(a,this).then({success:function(){this.fireEvent("hierarchyloadcomplete")},failure:function(a){this.fireEvent("hierarchyloaderror",a)},scope:this})},fetchNextLevel:function(a){if(this.logger.log("fetchNextLevel",a,a&&a.length),!a)return this.fetchRoot();if(a=_.flatten(a),this.logger.log("fetchNextLevel flattened args",a,a.length),a.length>0){var b=a[0].get("_type");this.fireEvent("hierarchyloadartifactsloaded",b,a);var c=_.pluck(this.portfolioItemTypes,"typePath"),d=_.indexOf(c,b);if(0===d&&Ext.Array.contains(this.loadChildModels,this.storyModelName))return this.fetchUserStories(a);if(d>0&&Ext.Array.contains(this.loadChildModels,c[d-1]))return this.fetchPortfolioItems(c[d-1],a);if(b===this.storyModelName&&Ext.Array.contains(this.loadChildModels,this.taskModelName))return this.fetchTasks(a)}return Promise.resolve([])},fetchRoot:function(){var a=this.fetch.concat(this.getRequiredFetchFields(this.model));this.fireEvent("statusupdate","Loading artifacts");var b={model:this.model,fetch:a,filters:this.filters};return this.logger.log("fetchRoot config",b),this.fetchWsapiRecords(b)},fetchPortfolioItems:function(a,b){var c=this.fetch.concat(this.getRequiredFetchFields(a)),d=this._getChunks(b,"Children","Count");return this.fetchChunks(a,c,d,"Parent.ObjectID",Ext.String.format("Please Wait... Loading Children for {0} Portfolio Items",b.length))},_getChunks:function(a,b,c){var d=[],e=0,f=100,g=200,h=0;return d[h]=[],_.each(a,function(a){var i=a.get(b);c&&i&&(i=i[c]),i>0&&(e+=i,(e>g||d[h].length>=f)&&(h++,d[h]=[],e=0),d[h].push(a.get("ObjectID")))}),d},fetchUserStories:function(a){var b=this.storyModelName,c=this.fetch.concat(this.getRequiredFetchFields(b)),d=this._getChunks(a,"LeafStoryCount"),e=this.portfolioItemTypes[0].name.replace(/\s/g,"")+".ObjectID";return this.fetchChunks(b,c,d,e,Ext.String.format("Please Wait... Loading User Stories for {0} Portfolio Items",a.length))},fetchTasks:function(a){var b=this.taskModelName,c=this.fetch.concat(this.getRequiredFetchFields(b)),d=this._getChunks(a,"Tasks","Count");return this.fetchChunks(b,c,d,"WorkProduct.ObjectID",Ext.String.format("Please Wait... Loading Tasks for {0} User Stories",a.length))},fetchChunks:function(a,b,c,d,e){if(this.logger.log("fetchChunks",b,d,c),c&&c.length>0&&0===c[0].length)return Promise.resolve([]);this.fireEvent("statusupdate",e);var f=[];return _.each(c,function(c){var e=_.map(c,function(a){return{property:d,value:a}}),g={model:a,fetch:b,filters:Rally.data.wsapi.Filter.or(e),context:{project:null}};f.push(function(){return this.fetchWsapiRecords(g)})}),this.throttle(f,this.maxParallelCalls,this)},fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred");return a.compact=!1,a.limit="Infinity",a.allowPostGet=!0,Ext.create("Rally.data.wsapi.Store",a).load({callback:function(a,c){c.wasSuccessful()?b.resolve(a):b.reject("fetchWsapiRecords error: "+c.error.errors.join(","))},scope:this}),b},getRequiredFetchFields:function(a){return/^portfolioitem/.test(a.toLowerCase())?["Children","LeafStoryCount","Parent","ObjectID"]:a.toLowerCase()===this.storyModelName?["FormattedID","Children","Tasks","Parent","PortfolioItem","HasParent","ObjectID"]:a.toLowerCase()===this.taskModelName?["WorkProduct","ObjectID"]:[]},throttle:function(a,b,c){if(0>=b||a.length<b)return Deft.promise.Chain.parallel(a,c);for(var d=[],e=[],f=-1,g=0;g<a.length;g++)g%b===0&&(f++,e[f]=[]),e[f].push(a[g]);return _.each(e,function(a){d.push(function(){return Deft.promise.Chain.parallel(a,c)})}),Deft.Promise.reduce(d,function(a,b){return Deft.Promise.when(b.call(c)).then(function(b){return a=a.concat(b||[])})},[])}}),Ext.override(Rally.ui.gridboard.plugin.GridBoardFieldPicker,{gridFieldBlackList:["Actuals","Changesets","Children","ObjectID","Predecessors","RevisionHistory","Subscription","Successors","TaskIndex","Workspace","VersionId"]}),Ext.override(Rally.ui.inlinefilter.PropertyFieldComboBox,{defaultWhiteListFields:["Milestones","Tags"]}),function(){var a=window.Ext4||window.Ext,b=function(a){return{name:a,xtype:"rallytextfield",hidden:!0,handlesEvents:{typeselected:function(a){this.setValue(null)}}}};a.define("Rally.technicalservices.CustomGridWithDeepExportSettings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.CheckboxField"],getFields:function(c){var d=Rally.data.wsapi.Filter.or([{property:"TypePath",value:"HierarchicalRequirement"},{property:"TypePath",operator:"contains",value:"PortfolioItem/"}]);return[{name:"type",xtype:"rallycombobox",allowBlank:!1,autoSelect:!1,shouldRespondToScopeChange:!0,context:c,initialValue:"HierarchicalRequirement",storeConfig:{model:a.identityFn("TypeDefinition"),sorters:[{property:"DisplayName"}],fetch:["DisplayName","ElementName","TypePath","Parent","UserListable"],filters:d,autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{select:function(a){a.fireEvent("typeselected",a.getRecord().get("TypePath"),a.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(a){this.refreshWithNewContext(a)}}},{type:"query"},{name:"showControls",xtype:"rallycheckboxfield",fieldLabel:"Show Control Bar"},b("columnNames"),b("order")]}})}(),Ext.define("custom-grid-with-deep-export",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},items:[{xtype:"container",itemId:"message_box",tpl:"Hello, <tpl>{_refObjectName}</tpl>"},{xtype:"container",itemId:"display_box"}],config:{defaultSettings:{columnNames:["FormattedID","Name","ScheduleState"],query:"",showControls:!0,type:"HierarchicalRequirement",pageSize:50}},integrationHeaders:{name:"custom-grid-with-deep-export"},disallowedAddNewTypes:["user","userprofile","useriterationcapacity","testcaseresult","task","scmrepository","project","changeset","change","builddefinition","build","program"],orderedAllowedPageSizes:[10,25,50,100,200],readOnlyGridTypes:["build","change","changeset"],statePrefix:"customlist",allowExpansionStateToBeSaved:!1,enableAddNew:!0,launch:function(){this.fetchPortfolioItemTypes().then({success:function(a){this.portfolioItemTypes=a,this._buildStore()},failure:function(a){this._showError(a)},scope:this})},_buildStore:function(){this.modelNames=[this.getSetting("type")],this.logger.log("_buildStore",this.modelNames);var a=["FormattedID","Name"];Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:this.modelNames,enableHierarchy:!0,fetch:a}).then({success:this._addGridboard,scope:this})},_addGridboard:function(a){this.down("#display_box")&&this.down("#display_box").removeAll();var b=this.getSetting("query")?Rally.data.wsapi.Filter.fromQueryString(this.getSetting("query")):[];this.logger.log("_addGridboard",a),this.gridboard=this.down("#display_box").add({xtype:"rallygridboard",context:this.getContext(),modelNames:this.modelNames,toggleState:"grid",plugins:["rallygridboardaddnew",{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("filters-1"),modelNames:this.modelNames,inlineFilterPanelConfig:{quickFilterPanelConfig:{whiteListFields:["Tags","Milestones"],defaultFields:["ArtifactSearch","Owner","ModelType","Milestones"]}}}},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:this.modelNames},{ptype:"rallygridboardactionsmenu",menuItems:this._getExportMenuItems(),buttonConfig:{iconCls:"icon-export"}}],cardBoardConfig:{attribute:"ScheduleState"},gridConfig:{store:a,storeConfig:{filters:b},columnCfgs:["Name"]},height:this.getHeight()})},_getExportMenuItems:function(){if(this.logger.log("_getExportMenuItems",this.modelNames[0]),"hierarchicalrequirement"===this.modelNames[0].toLowerCase())return[{text:"Export User Stories...",handler:this._export,scope:this,childModels:[]},{text:"Export User Stories and Tasks...",handler:this._export,scope:this,childModels:["task"]}];var a=_.indexOf(this.getPortfolioItemTypeNames(),this.modelNames[0].toLowerCase()),b=[];if(a>0)for(var c=a;c>0;c--)b.push(this.getPortfolioItemTypeNames()[c-1].toLowerCase());return[{text:"Export Portfolio Items...",handler:this._export,scope:this,childModels:b},{text:"Export Portfolio Items and User Stories...",handler:this._export,scope:this,includeStories:!0,includeTasks:!1,childModels:b.concat(["hierarchicalrequirement"])},{text:"Export Portfolio Items, User Stories and Tasks...",handler:this._export,scope:this,childModels:b.concat(["hierarchicalrequirement","task"])}]},getPortfolioItemTypeNames:function(){return _.pluck(this.portfolioItemTypes,"typePath")},_showError:function(a){Rally.ui.notify.Notifier.showError({message:a})},_showStatus:function(a){this.logger.log("_showstatus",a,this),a?Rally.ui.notify.Notifier.showStatus({message:a,showForever:!0,closable:!1,animateShowHide:!1}):Rally.ui.notify.Notifier.hide()},_getExportColumns:function(){var a=this.down("rallygridboard").getGridOrBoard();return a?_.filter(a.columns,function(a){return a.dataIndex&&"DragAndDropRank"!=a.dataIndex}):[]},_getExportFilters:function(){var a=this.down("rallygridboard"),b=[],c=this.getSetting("query");return a.currentCustomFilter&&a.currentCustomFilter.filters&&(b=a.currentCustomFilter.filters),c?b&&b.length>0?b.and(b,Rally.data.wsapi.Filter.fromQueryString(c)):Rally.data.wsapi.Filter.fromQueryString(c):b},_getExportFetch:function(){var a=_.pluck(this._getExportColumns(),"dataIndex");return Ext.Array.contains(a,"TaskActualTotal")&&a.push("Actuals"),a},_export:function(a){var b=this._getExportColumns(),c=this._getExportFetch(),d=this._getExportFilters(),e=this.modelNames[0],f=a.childModels;this.logger.log("_export",c,a,b,d.toString(),f);var g=Ext.create("Rally.technicalservices.HierarchyExporter",{fileName:"hierarchy-export.csv",columns:b,portfolioItemTypeObjects:this.portfolioItemTypes});g.on("exportupdate",this._showStatus,this),g.on("exporterror",this._showError,this),g.on("exportcomplete",this._showStatus,this);var h=Ext.create("Rally.technicalservices.HierarchyLoader",{model:e,fetch:c,filters:d,loadChildModels:f,portfolioItemTypes:this.portfolioItemTypes,context:this.getContext().getDataContext()});h.on("statusupdate",this._showStatus,this),h.on("hierarchyloadartifactsloaded",g.setRecords,g),h.on("hierarchyloadcomplete",g["export"],g),h.on("hierarchyloaderror",this._showError,this),h.load()},getHeight:function(){var a=this.getEl();if(a){var b=this.callParent(arguments);return Ext.isIE8?Math.max(b,600):b}return 0},setHeight:function(a){this.callParent(arguments),this.gridboard&&this.gridboard.setHeight(a)},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},getSettingsFields:function(){return Rally.technicalservices.CustomGridWithDeepExportSettings.getFields()},onSettingsUpdate:function(a){this.logger.log("onSettingsUpdate",a),this._buildStore()},fetchPortfolioItemTypes:function(){var a=Ext.create("Deft.Deferred"),b=Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]});return b.load({callback:function(b,c,d){if(d){var e=new Array(b.length);_.each(b,function(a){var b=Number(a.get("Ordinal"));e[b]={typePath:a.get("TypePath").toLowerCase(),name:a.get("Name")}}),a.resolve(e)}else{var f="";c&&c.error&&c.error.errors&&(f=c.error.errors.join(",")),a.reject("Error loading Portfolio Item Types:  "+f)}}}),a.promise}});
            
               Rally.launchApp('custom-grid-with-deep-export', {
                   name: 'Custom Grid with Deep Export'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>